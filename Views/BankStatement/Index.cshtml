@using FileUploadReader.ViewModels
@{
    ViewData["Title"] = "Bank Statement Page";
    var filePath = ViewBag.UploadedFilePath as string;
}

@section Styles {
    <style>
        body {
            background: linear-gradient(to right, #92ace8, #ffffff);
        }

        .invoice-section {
            padding: 20px 0;
        }

        .invoice-header {
            font-size: 28px;
            font-weight: 600;
            color: #003d66;
            margin-bottom: 20px;
        }

        .btn-custom {
            font-weight: bold;
            padding: 0.5rem 1.25rem;
            border-radius: 6px;
        }

        .preview-box,
        .details-box {
            background: #ffffffd0;
            border-radius: 8px;
            padding: 15px;
        }
    </style>
}

@section Scripts {
    <script>

        function showLoader() {
             document.getElementById('loader').style.display = 'block';
         }

        // Prevent browser back button
        (function () {
            history.pushState(null, null, location.href);
            window.onpopstate = function () {
                history.go(1); // Forces browser to move forward again
            };
        })();
    </script>
}

<div class="container invoice-section">

    <div class="text-center mb-2">
        <h2 class="invoice-header">Bank Statement Analyzer</h2>
    </div>

    <div class="row align-items-center mb-3">

        <div class="col-auto">
            <a asp-controller="Home" asp-action="Index" class="btn btn-warning text-white" style="background-color:#ff8c00;">← Back to Home</a>
        </div>

        <div class="col d-flex justify-content-center gap-2">

            <form id="uploadForm" asp-controller="BankStatement" asp-action="UploadBankStatement" method="post" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
                <input type="file" name="file" class="form-control" style="width: 250px;" onchange="document.getElementById('uploadForm').submit();" />
            </form>

            <form asp-controller="BankStatement" asp-action="AnalyzeBankStatement" method="post" onsubmit="showLoader()">
                <button type="submit" class="btn btn-warning text-white" style="background-color:#ff8c00;">Abstract Info (SDK)</button>
            </form>

        </div>
    </div>


    <div class="row">
        <div class="col-md-6">
            <h5 class="fw-bold mb-2">File Preview</h5>
            <div class="preview-box">
                @if (!string.IsNullOrEmpty(filePath))
                {
                    var fileExt = System.IO.Path.GetExtension(filePath).ToLower();

                    if (fileExt == ".png" || fileExt == ".jpg" || fileExt == ".jpeg")
                    {
                        <img src="@filePath" class="img-fluid" />
                    }
                    else if (fileExt == ".pdf")
                    {
                        <iframe src="@filePath"
                                width="100%"
                                height="900px"
                                style="border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        </iframe>
                    }
                    else
                    {
                        <p class="text-muted">Preview not available for this file type.</p>
                    }
                }
                else
                {
                    <p class="text-muted">No business card uploaded yet.</p>
                }
            </div>
        </div>

        <div class="col-md-6" style="position: relative;">
            <h5 class="fw-bold mb-2">Extracted Details</h5>

            <div id="loader" class="text-center" style="display:none; position: absolute; top: 120px; left: 50%; transform: translateX(-50%); z-index: 10; background: rgba(255,255,255,0.9); padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 fw-bold text-primary">Processing, please wait...</p>
            </div>

            @if (ViewBag.ExtractedFields is List<InvoiceField> fields && fields.Count > 0)
            {
                <div class="details-box">
                    <div class="row fw-bold border-bottom pb-1 mb-1">
                        <div class="col-4">Field</div>
                        <div class="col-5">Value</div>
                        <div class="col-3">Confidence</div>
                    </div>

                    @foreach (var field in fields)
                    {
                        <div class="row mb-2 border-bottom pb-2">
                            <div class="col-4 fw-bold">@field.Key</div>
                            <div class="col-5">@field.Value</div>
                            <div class="col-3 text-muted" style="text-align: center;">
                                @(field.Confidence.HasValue ? $"{field.Confidence:P0}" : "N/A")
                            </div>
                        </div>
                    }


                </div>
            }

            @if (ViewBag.ExtractedTransactions is List<BankTransaction> transactions && transactions.Count > 0)
            {
                <h5 class="fw-bold mt-4 mb-2">Extracted Transactions</h5>

                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-bordered table-hover table-sm" style="min-width: 1000px;">
                        <thead class="table-light text-center">
                            <tr>
                                <th style="width: 120px;">Date</th>
                                <th style="width: 200px;">Withdrawal</th>
                                <th>Description</th>
                                <th style="width: 150px;">Check/Ref</th>
                                <th style="width: 150px;">Deposit</th>
                                <th style="width: 100px;">Conf.</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var tx in transactions)
                            {
                                <tr>
                                    <td>@tx.Date?.ToString("dd MMM yyyy")</td>
                                    <td class="text-danger">@((tx.WithdrawalAmount.HasValue && tx.WithdrawalAmount > 0) ? $"{tx.WithdrawalAmount:C}" : "")</td>
                                    <td>
                                        <div>@tx.Description</div>
                                    </td>
                                    <td>@tx.CheckNumber</td>
                                    <td class="text-success text-end">@((tx.DepositAmount.HasValue && tx.DepositAmount > 0) ? $"{tx.DepositAmount:C}" : "")</td>
                                    <td class="text-center">@($"{(tx.Confidence ?? 0):P0}")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }

        </div>
    </div>
</div>